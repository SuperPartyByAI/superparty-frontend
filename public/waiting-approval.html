<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SuperParty - În așteptarea aprobării</title>
  <style>
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:#0f172a;
      color:#e2e8f0;
      padding:24px
    }
    .card{
      max-width:560px;
      width:100%;
      background:rgba(15,23,42,.9);
      border:1px solid #334155;
      border-radius:18px;
      padding:22px
    }
    h1{margin:0 0 10px;font-size:20px}
    p{margin:0 0 14px;line-height:1.45;color:#cbd5e1}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    button{
      cursor:pointer;border:0;border-radius:12px;
      padding:10px 14px;font-weight:700;background:#2563eb;color:white
    }
    button.secondary{background:#334155}
    .muted{font-size:12px;color:#94a3b8;margin-top:12px}
    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid #334155;
      background:rgba(2,6,23,.35);
      color:#cbd5e1;
      margin:8px 0 14px;
    }
    .statusline{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .small{font-size:12px;color:#94a3b8}
    .warn{color:#fbbf24}
    .ok{color:#34d399}
    .bad{color:#fb7185}
    .loading{opacity:.85}
    a{color:#93c5fd}
  </style>
</head>

<body>
  <div class="card">
    <h1 id="title">Verific statusul contului…</h1>

    <div class="statusline">
      <span class="pill" id="pill">Se verifică…</span>
      <span class="small" id="lastCheck"></span>
    </div>

    <p id="desc" class="loading">
      Te rugăm să aștepți. Dacă ai fost aprobat, vei fi redirecționat automat.
    </p>

    <div class="row">
      <button id="btnRetry" type="button">Reverifică acum</button>
      <button id="btnGoDash" type="button" class="secondary" style="display:none;">Mergi la dashboard</button>
      <button id="btnLogin" type="button" class="secondary" style="display:none;">Mergi la login</button>
      <button id="btnLogout" type="button" class="secondary">Delogare</button>
    </div>

    <div class="muted">
      SuperParty · Dacă pagina rămâne blocată pe “pending” deși ești aprobat, apasă “Reverifică acum”.
    </div>
  </div>

  <script>
    (function () {
      "use strict";

      // ===== CONFIG =====
      const BACKEND = "https://superparty-ai-backend-production.up.railway.app";
      const DASHBOARD_URL = "/angajat/";      // ajustează dacă dashboard-ul tău e în altă parte
      const LOGIN_URL = "/login.html";
      const CHECK_INTERVAL_MS = 12000;        // 12 sec

      // ===== UI =====
      const elTitle = document.getElementById("title");
      const elDesc = document.getElementById("desc");
      const elPill = document.getElementById("pill");
      const elLast = document.getElementById("lastCheck");

      const btnRetry = document.getElementById("btnRetry");
      const btnGoDash = document.getElementById("btnGoDash");
      const btnLogin = document.getElementById("btnLogin");
      const btnLogout = document.getElementById("btnLogout");

      function setLastCheck() {
        const d = new Date();
        elLast.textContent = "Ultima verificare: " + d.toLocaleString("ro-RO");
      }

      function setState(textPill, title, desc, pillClass) {
        elPill.textContent = textPill;
        elPill.className = "pill" + (pillClass ? (" " + pillClass) : "");
        elTitle.textContent = title;
        elDesc.innerHTML = desc;
        setLastCheck();
      }

      function redirectTo(url) {
        window.location.replace(url);
      }

      function logout() {
        localStorage.removeItem("sp_token");
        localStorage.removeItem("sp_user");
        redirectTo(LOGIN_URL);
      }

      async function checkStatus() {
        btnRetry.disabled = true;

        const token = (localStorage.getItem("sp_token") || "").trim();
        if (!token) {
          setState(
            "Fără sesiune",
            "Nu ești autentificat",
            "Nu există token salvat. Te trimit către pagina de login.",
            "warn"
          );
          btnLogin.style.display = "";
          btnGoDash.style.display = "none";
          btnRetry.disabled = false;
          setTimeout(() => redirectTo(LOGIN_URL), 700);
          return;
        }

        try {
          const r = await fetch(`${BACKEND}/api/auth/me`, {
            headers: { Authorization: `Bearer ${token}` }
          });

          if (r.status === 401) {
            setState(
              "Sesiune invalidă",
              "Sesiunea a expirat / token invalid",
              "Te trimit către login pentru re-autentificare.",
              "warn"
            );
            btnLogin.style.display = "";
            btnGoDash.style.display = "none";
            btnRetry.disabled = false;
            setTimeout(() => redirectTo(LOGIN_URL), 700);
            return;
          }

          const j = await r.json().catch(() => null);
          const u = j && j.tokenUser ? j.tokenUser : null;

          if (!u) {
            setState(
              "Eroare",
              "Nu am putut citi statusul",
              "Serverul nu a returnat datele așteptate. Apasă “Reverifică acum”.",
              "warn"
            );
            btnRetry.disabled = false;
            return;
          }

          // IMPORTANT: sincronizăm sp_user ca să nu rămână “pending” vechi în frontend
          localStorage.setItem("sp_user", JSON.stringify(u));

          const status = String(u.status || "").toLowerCase();

          if (status === "approved") {
            setState(
              "Aprobat",
              "Ești aprobat",
              "Contul este aprobat. Te redirecționez către dashboard.",
              "ok"
            );
            btnGoDash.style.display = "";
            btnLogin.style.display = "none";
            btnRetry.disabled = false;

            setTimeout(() => redirectTo(DASHBOARD_URL), 400);
            return;
          }

          if (status === "pending") {
            setState(
              "În așteptare",
              "Contul tău este în așteptarea aprobării",
              "Te rugăm să revii mai târziu. Pagina verifică periodic și te va redirecționa automat când ești aprobat.",
              "warn"
            );
            btnGoDash.style.display = "none";
            btnLogin.style.display = "none";
            btnRetry.disabled = false;
            return;
          }

          if (status === "rejected") {
            setState(
              "Respins",
              "Contul a fost respins",
              "Statusul contului este <b>rejected</b>. Dacă este o eroare, contactează administratorul sau re-trimite KYC.",
              "bad"
            );
            btnGoDash.style.display = "none";
            btnLogin.style.display = "none";
            btnRetry.disabled = false;
            return;
          }

          // fallback: orice alt status (ex: kyc_required etc.)
          setState(
            "Necesită acțiune",
            "Contul necesită completare",
            `Status detectat: <b>${status || "necunoscut"}</b>. Dacă trebuie KYC, completează onboarding-ul, apoi revino aici.`,
            "warn"
          );
          btnGoDash.style.display = "none";
          btnLogin.style.display = "none";
          btnRetry.disabled = false;

        } catch (e) {
          setState(
            "Eroare rețea",
            "Nu pot verifica statusul acum",
            "A apărut o eroare de rețea. Apasă “Reverifică acum”.",
            "warn"
          );
          btnRetry.disabled = false;
        }
      }

      btnRetry.addEventListener("click", checkStatus);
      btnGoDash.addEventListener("click", () => redirectTo(DASHBOARD_URL));
      btnLogin.addEventListener("click", () => redirectTo(LOGIN_URL));
      btnLogout.addEventListener("click", logout);

      // init
      checkStatus();
      setInterval(checkStatus, CHECK_INTERVAL_MS);
    })();
  </script>
</body>
</html>
