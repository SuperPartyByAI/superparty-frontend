<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>KYC Onboarding Final</title>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  background:#0f172a;
  color:#f1f5f9;
  padding:40px;
}
.kyc-container{
  max-width:1200px;
  margin:auto;
  background:rgba(15,23,42,.9);
  border-radius:30px;
  padding:50px;
  border:2px solid #334155;
}
.section{
  background:rgba(15,23,42,.8);
  border:2px solid #334155;
  border-radius:20px;
  padding:30px;
  margin-bottom:30px;
}
.upload-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:20px;
}
.upload-card{
  background:rgba(30,41,59,.6);
  border:2px dashed #475569;
  border-radius:16px;
  padding:30px;
  text-align:center;
  cursor:pointer;
  transition:0.2s;
}
.upload-card:hover{ border-color:#818cf8; background:rgba(30,41,59,.75); }
.upload-card input{display:none;}
.checkbox-large{
  display:flex;
  gap:12px;
  align-items:flex-start;
  background:rgba(30,41,59,.6);
  padding:20px;
  border-radius:16px;
  border:2px solid #475569;
}
.contract-box{
  display:none;
  margin-top:20px;
  padding:20px;
  border-radius:16px;
  border:2px solid #475569;
  background:rgba(15,23,42,.9);
  max-height:320px;
  overflow-y:auto;
  line-height:1.55;
  font-size:14px;
}
.btn{
  width:100%;
  padding:18px;
  border-radius:999px;
  background:linear-gradient(135deg,#667eea,#764ba2);
  border:none;
  color:white;
  font-size:18px;
  cursor:pointer;
}
.btn:disabled{ opacity:.6; cursor:not-allowed; }
.notice{
  margin-top:14px;
  padding:12px 14px;
  border-radius:14px;
  border:1px solid rgba(148,163,184,.35);
  background:rgba(2,6,23,.35);
  color:#cbd5e1;
  font-size:13px;
}
</style>
</head>

<body>
<div class="kyc-container">
  <h1>ğŸªª KYC Onboarding â€“ Varianta FinalÄƒ</h1>

  <div class="section">
    <h2>ğŸ‘¤ Documente identitate</h2>
    <div class="notice">
      ÃncarcÄƒ <strong>o pozÄƒ clarÄƒ</strong> cu buletinul (faÈ›Äƒ). DacÄƒ poza e blur / micÄƒ / neclarÄƒ, te oprim È™i Ã®È›i cerem sÄƒ refaci.
    </div>

    <div class="upload-grid" style="margin-top:16px;">
      <label class="upload-card">
        <div style="font-size:42px;">ğŸªª</div>
        <strong>Buletin â€“ FaÈ›Äƒ</strong>
        <div style="font-size:12px;color:#94a3b8;margin-top:6px;">JPG/PNG recomandat</div>
        <input id="idFront" type="file" accept="image/*">
      </label>

      <label class="upload-card">
        <div style="font-size:42px;">ğŸªª</div>
        <strong>Buletin â€“ Verso</strong>
        <div style="font-size:12px;color:#94a3b8;margin-top:6px;">(opÈ›ional Ã®n demo)</div>
        <input id="idBack" type="file" accept="image/*">
      </label>

      <label class="upload-card">
        <div style="font-size:42px;">ğŸ¤³</div>
        <strong>Selfie cu CI</strong>
        <div style="font-size:12px;color:#94a3b8;margin-top:6px;">(opÈ›ional Ã®n demo)</div>
        <input id="selfie" type="file" accept="image/*">
      </label>
    </div>
  </div>

  <div class="section" id="contractSection" style="display:none;">
    <h2>ğŸ“„ Contract colaborare</h2>

    <div class="checkbox-large" style="margin-top:12px;">
      <input type="checkbox" id="contractSignCheck" disabled>
      <span>Confirm cÄƒ am citit È™i accept contractul (dacÄƒ eÈ™ti minor, se deblocheazÄƒ doar dupÄƒ acord parental).</span>
    </div>

    <div class="contract-box" id="contractBox">
      <p>
        <strong>COLABORATOR:</strong> <span id="cName"></span><br>
        <strong>CNP:</strong> <span id="cCnp"></span><br>
        <strong>AdresÄƒ:</strong> <span id="cAddress"></span>
      </p>

      <hr style="border-color:#334155;margin:14px 0;">

      <p>
        <strong>CONTRACT DE COLABORARE</strong><br>
        Ãn cazul Ã®n care colaboratorul este minor, este obligatoriu acordul parental semnat.
      </p>

      <p style="color:#94a3b8;">
        (Demo) UrmÄƒtorul pas: integrare backend pentru extracÈ›ie realÄƒ CI + verificÄƒri OCR.
      </p>
    </div>
  </div>

  <div class="section" id="minorSection" style="display:none;">
    <h2>ğŸ§’ Acord parental necesar</h2>
    <p style="color:#facc15;">
      EÈ™ti minor. Pentru a putea semna contractul, Ã®ncarcÄƒ acord parental semnat.
    </p>

    <label class="upload-card" style="margin-top:14px;">
      <div style="font-size:42px;">ğŸ“„</div>
      <strong>Acord parental</strong>
      <div style="font-size:12px;color:#94a3b8;margin-top:6px;">PozÄƒ sau PDF</div>
      <input id="parentConsent" type="file" accept="image/*,.pdf">
    </label>
  </div>

  <button class="btn" onclick="submitKYC()">ğŸš€ Trimite KYC</button>
</div>

<script>
/* =========================
   Helper: minor din CNP
========================= */
function isMinorFromCnp(cnp){
  if(!cnp || cnp.length < 13) return false;
  const s = cnp[0];
  let prefix = "19";
  if(s === "5" || s === "6") prefix = "20";      // 2000+
  else if(s === "3" || s === "4") prefix = "18"; // 1800+ (rar)
  else if(s === "1" || s === "2") prefix = "19"; // 1900+
  else return false;

  const year = parseInt(prefix + cnp.substring(1,3), 10);
  const month = parseInt(cnp.substring(3,5), 10) - 1;
  const day = parseInt(cnp.substring(5,7), 10);

  const dob = new Date(year, month, day);
  if (isNaN(dob.getTime())) return false;

  const today = new Date();
  let age = today.getFullYear() - year;
  const m = today.getMonth() - month;
  if (m < 0 || (m === 0 && today.getDate() < day)) age--;
  return age < 18;
}

/* =========================
   Validare pozÄƒ CI faÈ›Äƒ
   - format
   - mÄƒrime max
   - rezoluÈ›ie minimÄƒ
   - blur check (edge energy)
========================= */
async function validateIdFrontImage(file) {
  if (!file) return { ok:false, reason:"Nu ai selectat niciun fiÈ™ier." };

  // acceptÄƒm doar imagini la demo
  if (!file.type || !file.type.startsWith("image/")) {
    return { ok:false, reason:"ÃncarcÄƒ o imagine (JPG/PNG). PDF-ul va fi acceptat dupÄƒ integrarea backend." };
  }

  const MAX_MB = 12;
  if (file.size > MAX_MB * 1024 * 1024) {
    return { ok:false, reason:`FiÈ™ier prea mare. Maxim ${MAX_MB}MB.` };
  }

  const img = new Image();
  const url = URL.createObjectURL(file);

  const loaded = await new Promise((resolve) => {
    img.onload = () => resolve(true);
    img.onerror = () => resolve(false);
    img.src = url;
  });

  if (!loaded) {
    URL.revokeObjectURL(url);
    return { ok:false, reason:"Nu pot citi imaginea. ÃncearcÄƒ alt fiÈ™ier." };
  }

  // rezoluÈ›ie minimÄƒ
  const MIN_W = 900;
  const MIN_H = 600;
  if (img.naturalWidth < MIN_W || img.naturalHeight < MIN_H) {
    URL.revokeObjectURL(url);
    return { ok:false, reason:`PozÄƒ prea micÄƒ (${img.naturalWidth}Ã—${img.naturalHeight}). FÄƒ o pozÄƒ mai aproape È™i clarÄƒ.` };
  }

  // blur check (downscale)
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d", { willReadFrequently: true });

  const targetW = 600;
  const scale = targetW / img.naturalWidth;
  canvas.width = targetW;
  canvas.height = Math.round(img.naturalHeight * scale);

  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = imageData.data;

  const gray = new Float32Array(canvas.width * canvas.height);
  for (let i = 0, p = 0; i < data.length; i += 4, p++) {
    gray[p] = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
  }

  let sum = 0;
  let count = 0;
  const w = canvas.width;
  const h = canvas.height;

  for (let y = 1; y < h - 1; y++) {
    for (let x = 1; x < w - 1; x++) {
      const c = gray[y * w + x];
      const dx = Math.abs(c - gray[y * w + (x - 1)]) + Math.abs(c - gray[y * w + (x + 1)]);
      const dy = Math.abs(c - gray[(y - 1) * w + x]) + Math.abs(c - gray[(y + 1) * w + x]);
      sum += (dx + dy);
      count++;
    }
  }

  URL.revokeObjectURL(url);

  const sharpness = sum / Math.max(1, count);
  const MIN_SHARPNESS = 13;

  if (sharpness < MIN_SHARPNESS) {
    return { ok:false, reason:`Poza pare miÈ™catÄƒ/blur (scor ${sharpness.toFixed(1)}). RefÄƒ poza cu luminÄƒ È™i fÄƒrÄƒ miÈ™care.` };
  }

  return { ok:true, sharpness };
}

/* =========================
   State intern
========================= */
let idFrontOk = false;
let extracted = null;

/* =========================
   Handler CI faÈ›Äƒ
========================= */
document.getElementById("idFront").addEventListener("change", async () => {
  const file = document.getElementById("idFront").files?.[0];
  const signCheck = document.getElementById("contractSignCheck");

  // reset UI
  idFrontOk = false;
  extracted = null;
  signCheck.checked = false;
  signCheck.disabled = true;
  document.getElementById("contractSection").style.display = "none";
  document.getElementById("minorSection").style.display = "none";
  document.getElementById("contractBox").style.display = "none";

  const res = await validateIdFrontImage(file);
  if (!res.ok) {
    alert("âŒ Buletin faÈ›Äƒ invalid: " + res.reason);
    return;
  }

  idFrontOk = true;

  // DEMO extract (aici va fi backend OCR)
  // Pentru test minor -> 5/6; pentru major -> 1/2
  const data = {
    name: "TEST MINOR",
    cnp: "5230101123456",
    address: "BucureÈ™ti"
  };
  extracted = data;

  document.getElementById("cName").textContent = data.name;
  document.getElementById("cCnp").textContent = data.cnp;
  document.getElementById("cAddress").textContent = data.address;

  document.getElementById("contractSection").style.display = "block";
  document.getElementById("contractBox").style.display = "block";

  const minor = isMinorFromCnp(data.cnp);

  if (minor) {
    document.getElementById("minorSection").style.display = "block";
    signCheck.disabled = true; // se deblocheazÄƒ doar dupÄƒ acord parental
  } else {
    document.getElementById("minorSection").style.display = "none";
    signCheck.disabled = false;
  }
});

/* =========================
   Acord parental -> deblocare semnare
========================= */
document.getElementById("parentConsent").addEventListener("change", () => {
  const consent = document.getElementById("parentConsent").files?.[0];
  if (consent) document.getElementById("contractSignCheck").disabled = false;
});

/* =========================
   Submit (demo strict)
========================= */
function submitKYC(){
  if (!idFrontOk) {
    alert("âŒ Nu poÈ›i trimite: poza CI faÈ›Äƒ nu e validÄƒ sau nu a fost Ã®ncÄƒrcatÄƒ.");
    return;
  }
  if (!extracted) {
    alert("âŒ Nu poÈ›i trimite: nu avem date extrase din buletin.");
    return;
  }

  const signCheck = document.getElementById("contractSignCheck");
  if (signCheck.disabled || !signCheck.checked) {
    alert("âŒ BifeazÄƒ acceptarea contractului (È™i acord parental dacÄƒ e minor).");
    return;
  }

  alert("âœ… OK: pozÄƒ CI validÄƒ + contract acceptat. UrmÄƒtorul pas este integrarea backend pentru verificare realÄƒ OCR + submit real.");
}
</script>
</body>
</html>
