<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <title>SuperParty - Formular KYC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #1d4ed8 0, #0f172a 45%, #020617 100%);
      padding: 16px;
      color: #e5e7eb;
    }

    .page {
      width: 100%;
      max-width: 900px;
      background: rgba(15, 23, 42, 0.96);
      border-radius: 18px;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.3);
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      gap: 0;
      overflow: hidden;
    }

    @media (max-width: 850px) {
      .page {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .left {
      padding: 22px 22px 18px 22px;
      border-right: 1px solid rgba(31, 41, 55, 0.95);
    }

    .right {
      padding: 22px 22px 18px 22px;
      background: radial-gradient(circle at top right, rgba(59, 130, 246, 0.35), rgba(15, 23, 42, 0.98));
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 14px;
    }

    .logo-mark {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      background: radial-gradient(circle at 25% 0, #f97316, #db2777 40%, #1d4ed8 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 17px;
      font-weight: 800;
      color: #f9fafb;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.9);
    }

    .logo-text-main {
      font-size: 17px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .logo-text-sub {
      font-size: 10px;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.18em;
    }

    .title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .subtitle {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 16px;
    }

    form {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 10px 14px;
    }

    @media (max-width: 600px) {
      form {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .full-row {
      grid-column: 1 / -1;
    }

    label {
      font-size: 12px;
      color: #e5e7eb;
      margin-bottom: 4px;
      display: block;
    }

    label span {
      color: #f97373;
    }

    input[type="text"],
    input[type="email"],
    input[type="tel"],
    input[type="file"],
    textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
      padding: 7px 9px;
      font-size: 13px;
      outline: none;
      transition: border 0.15s, box-shadow 0.15s, background 0.15s;
    }

    input[type="file"] {
      padding: 6px 7px;
      font-size: 12px;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    input:focus,
    textarea:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.4);
      background: rgba(15, 23, 42, 0.98);
    }

    .inline-note {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 2px;
    }

    .checkbox-row {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      font-size: 12px;
      color: #e5e7eb;
    }

    .checkbox-row input {
      margin-top: 3px;
    }

    .checkbox-row a {
      color: #93c5fd;
      text-decoration: underline;
      text-decoration-thickness: 1px;
    }

    .buttons-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .btn-primary,
    .btn-secondary {
      border-radius: 999px;
      border: none;
      padding: 9px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #0f172a;
    }

    .btn-secondary {
      background: rgba(15, 23, 42, 0.85);
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.8);
    }

    .status-box {
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.65);
      background: rgba(15, 23, 42, 0.9);
      padding: 12px 12px 11px 12px;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .status-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #93c5fd;
    }

    .status-main {
      font-size: 13px;
      font-weight: 500;
    }

    .status-sub {
      font-size: 11px;
      color: #9ca3af;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #facc15;
      box-shadow: 0 0 0 4px rgba(250, 204, 21, 0.28);
      margin-right: 6px;
    }

    .status-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .steps-list {
      list-style: none;
      padding-left: 0;
      margin-top: 10px;
      font-size: 12px;
      color: #e5e7eb;
    }

    .steps-list li {
      display: flex;
      gap: 8px;
      margin-bottom: 6px;
    }

    .steps-list li span {
      margin-top: 1px;
    }

    .highlight {
      color: #bfdbfe;
      font-weight: 500;
    }

    .small-muted {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 8px;
    }

    .error-msg {
      margin-top: 8px;
      font-size: 12px;
      color: #fecaca;
      background: rgba(127, 29, 29, 0.6);
      border-radius: 10px;
      padding: 7px 9px;
      display: none;
    }

    .success-msg {
      margin-top: 8px;
      font-size: 12px;
      color: #bbf7d0;
      background: rgba(22, 163, 74, 0.5);
      border-radius: 10px;
      padding: 7px 9px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- COL STÂNGA: FORMULAR KYC -->
    <section class="left">
      <div class="logo">
        <div class="logo-mark">SP</div>
        <div>
          <div class="logo-text-main">SuperParty</div>
          <div class="logo-text-sub">Formular KYC</div>
        </div>
      </div>

      <h1 class="title">Date identitate &amp; contract</h1>
      <p class="subtitle">
        Completează formularul de mai jos cu date reale. Informațiile sunt folosite pentru contract, plăți și verificări interne.
      </p>

      <form id="kycForm" enctype="multipart/form-data">
        <div class="full-row">
          <label for="fullName">Nume complet <span>*</span></label>
          <input id="fullName" name="fullName" type="text" placeholder="ex: Popescu Andrei-Mihai" required />
          <p class="inline-note">Trebuie să coincidă cu numele din actul de identitate.</p>
        </div>

        <div>
          <label for="email">Email <span>*</span></label>
          <input id="email" name="email" type="email" placeholder="emailul tău" required />
        </div>

        <div>
          <label for="phone">Telefon <span>*</span></label>
          <input id="phone" name="phone" type="tel" placeholder="ex: 07xxxxxxxx" required />
        </div>

        <div>
          <label for="cnp">CNP <span>*</span></label>
          <input id="cnp" name="cnp" type="text" placeholder="13 cifre" required />
        </div>

        <div>
          <label for="iban">IBAN pentru plată <span>*</span></label>
          <input id="iban" name="iban" type="text" placeholder="ex: RO49AAAA1B31007593840000" required />
        </div>

        <div class="full-row">
          <label for="address">Adresă completă <span>*</span></label>
          <textarea id="address" name="address" placeholder="Stradă, număr, bloc/scară, oraș, județ" required></textarea>
        </div>

        <div class="full-row">
          <label>Poza CI față <span>*</span></label>
          <input id="idFront" name="idFront" type="file" accept="image/*,.pdf" required />
          <p class="inline-note">Se acceptă fotografie clară sau scan/PDF.</p>
        </div>

        <div class="full-row">
          <label>Poza CI verso <span>*</span></label>
          <input id="idBack" name="idBack" type="file" accept="image/*,.pdf" required />
        </div>

        <div class="full-row">
          <label>Selfie cu CI în mână <span>*</span></label>
          <input id="selfie" name="selfie" type="file" accept="image/*" required />
          <p class="inline-note">Fața și actul trebuie să fie clar vizibile în poză.</p>
        </div>

        <div class="full-row">
          <label>Contract semnat (poză sau PDF) <span>*</span></label>
          <input id="contractSigned" name="contractSigned" type="file" accept="image/*,.pdf" required />
        </div>

        <div class="full-row">
          <div class="checkbox-row">
            <input id="acceptContract" type="checkbox" required />
            <label for="acceptContract">
              Confirm că am citit și sunt de acord cu <a href="#" onclick="return false;">contractul SuperParty</a> și
              că datele trimise sunt reale.
            </label>
          </div>
        </div>

        <div class="full-row">
          <div class="buttons-row">
            <button type="submit" class="btn-primary" id="submitBtn">Trimite KYC pentru verificare</button>
            <button type="button" class="btn-secondary" id="backBtn">Înapoi la status cont</button>
          </div>

          <div id="errorBox" class="error-msg"></div>
          <div id="successBox" class="success-msg"></div>
        </div>
      </form>
    </section>

    <!-- COL DREAPTA: EXPLICAȚII + STATUS -->
    <section class="right">
      <div class="status-box">
        <div class="status-label">Status KYC</div>
        <div class="status-row">
          <div class="status-dot"></div>
          <div class="status-main" id="statusMainText">În curs de completare</div>
        </div>
        <div class="status-sub" id="statusSubText">
          Completează formularul din stânga, încarcă pozele cerute și semnează contractul. După trimitere, KYC-ul intră la verificare.
        </div>
      </div>

      <ul class="steps-list">
        <li>
          <span>1.</span>
          <span>Verifică să fie corecte <span class="highlight">CNP-ul, IBAN-ul și adresa</span>. Acestea vor apărea în contract și la plată.</span>
        </li>
        <li>
          <span>2.</span>
          <span>Pozele cu actul trebuie să fie <span class="highlight">clare, nemodificate</span> și făcute direct de tine.</span>
        </li>
        <li>
          <span>3.</span>
          <span>Selfie-ul cu actul în mână trebuie să fie făcut special pentru SuperParty (nu poze vechi).</span>
        </li>
        <li>
          <span>4.</span>
          <span>După ce apeși <span class="highlight">Trimite KYC</span>, un coordonator verifică manual datele.</span>
        </li>
      </ul>

      <p class="small-muted">
        După aprobare, <span class="highlight">statusul KYC</span> va deveni <span class="highlight">"approved"</span>, iar contul tău
        va putea fi activat pentru evenimente. Vei vedea automat schimbarea în pagina de <span class="highlight">"Cont în verificare"</span>.
      </p>
    </section>
  </div>

  <script>
    (function () {
      const BACKEND_BASE_URL = "https://superparty-ai-backend-production.up.railway.app";

      const emailLS = localStorage.getItem("userEmail") || "";
      const fullNameLS = localStorage.getItem("userFullName") || "";
      const kycStatusLS = (localStorage.getItem("userKycStatus") || "").toLowerCase();
      const statusLS = (localStorage.getItem("userStatus") || "").toLowerCase();

      // Dacă nu e logat, scoatem utilizatorul afară
      if (!emailLS) {
        window.location.replace("/login.html");
        return;
      }

      // Dacă deja e approved + activ, nu are ce căuta în KYC -> du-l în dashboard
      if (statusLS === "active" && kycStatusLS === "approved") {
        window.location.replace("/angajat/index.html");
        return;
      }

      // Pre-populare formular
      const fullNameInput = document.getElementById("fullName");
      const emailInput = document.getElementById("email");
      if (fullNameLS && fullNameInput) fullNameInput.value = fullNameLS;
      if (emailLS && emailInput) emailInput.value = emailLS;

      // Ajustăm status text în dreapta dacă deja există un KYC trimis
      const statusMainText = document.getElementById("statusMainText");
      const statusSubText = document.getElementById("statusSubText");

      if (kycStatusLS === "pending") {
        if (statusMainText) statusMainText.textContent = "KYC trimis - în curs de verificare";
        if (statusSubText) statusSubText.textContent =
          "Am primit datele și documentele tale. Un coordonator SuperParty verifică manual KYC-ul. Vei vedea statusul actualizat în pagina de 'Cont în verificare'.";
      } else if (kycStatusLS === "rejected") {
        if (statusMainText) statusMainText.textContent = "KYC respins - este nevoie de refacere";
        if (statusSubText) statusSubText.textContent =
          "Anteriorul KYC a fost respins. Te rugăm să refaci pozele sau datele conform instrucțiunilor primite și să retrimiți formularul.";
      }

      const form = document.getElementById("kycForm");
      const submitBtn = document.getElementById("submitBtn");
      const backBtn = document.getElementById("backBtn");
      const errorBox = document.getElementById("errorBox");
      const successBox = document.getElementById("successBox");

      function showError(msg) {
        if (!errorBox) return;
        errorBox.textContent = msg;
        errorBox.style.display = "block";
        if (successBox) successBox.style.display = "none";
      }

      function showSuccess(msg) {
        if (!successBox) return;
        successBox.textContent = msg;
        successBox.style.display = "block";
        if (errorBox) errorBox.style.display = "none";
      }

      if (backBtn) {
        backBtn.addEventListener("click", function () {
          window.location.href = "/angajat/pending.html";
        });
      }

      if (form) {
        form.addEventListener("submit", async function (e) {
          e.preventDefault();
          if (errorBox) errorBox.style.display = "none";
          if (successBox) successBox.style.display = "none";

          if (!submitBtn) return;
          submitBtn.disabled = true;
          submitBtn.textContent = "Se trimite KYC...";

          try {
            const formData = new FormData(form);

            // ne asigurăm că emailul & numele din localStorage sunt trimise
            formData.set("email", emailInput.value || emailLS);
            formData.set("fullName", fullNameInput.value || fullNameLS);
            formData.set("status", statusLS || "pending_admin");
            formData.set("kyc_status", kycStatusLS || "none");

            const response = await fetch(BACKEND_BASE_URL + "/api/kyc/submit", {
              method: "POST",
              body: formData
            });

            const data = await response.json().catch(() => null);

            if (!response.ok) {
              const msg = (data && data.error) || "Nu am putut trimite KYC-ul. Încearcă din nou.";
              throw new Error(msg);
            }

            if (!data || data.success === false) {
              const msg = (data && data.error) || "A apărut o problemă la trimiterea KYC-ului.";
              throw new Error(msg);
            }

            // Dacă totul e ok, marcăm KYC ca pending în localStorage și îl ducem în pending.html
            try {
              localStorage.setItem("userKycStatus", "pending");
            } catch (e) {}

            showSuccess("KYC trimis cu succes. Vei fi redirecționat către pagina de status cont.");
            setTimeout(function () {
              window.location.href = "/angajat/pending.html";
            }, 1200);
          } catch (err) {
            showError(err.message || "Nu am putut trimite KYC-ul. Verifică datele și pozele și încearcă din nou.");
          } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = "Trimite KYC pentru verificare";
          }
        });
      }
    })();
  </script>
</body>
</html>
