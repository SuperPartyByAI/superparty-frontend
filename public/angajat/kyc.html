<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>KYC Onboarding Final</title>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background:#0f172a; color:#f1f5f9; padding:40px; }
  .kyc-container { max-width:1200px; margin:0 auto; background:rgba(15,23,42,0.9); border-radius:30px; padding:50px; border:2px solid #334155; }
  .section { background:rgba(15,23,42,0.8); border:2px solid #334155; border-radius:20px; padding:30px; margin-bottom:30px; }
  .contract-box { margin-top:20px; padding:20px; border-radius:16px; border:2px solid #475569; background:rgba(15,23,42,0.9); max-height:260px; overflow-y:auto; font-size:14px; line-height:1.6; display:none; }
  .contract-trigger { margin-top:10px; padding:18px 20px; border-radius:16px; border:2px solid #475569; background:rgba(15,23,42,0.5); display:flex; justify-content:space-between; align-items:center; cursor:pointer; transition:0.2s; }
  .contract-trigger:hover { border-color:#818cf8; background:rgba(15,23,42,0.8); }
  .contract-trigger-title { font-weight:600; }
  .contract-trigger-hint { font-size:13px; color:#94a3b8; }
  .upload-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(250px,1fr)); gap:20px; }
  .upload-card { background:rgba(30,41,59,0.6); border:2px dashed #475569; border-radius:16px; padding:30px; text-align:center; cursor:pointer; transition:0.3s; }
  .upload-card:hover { border-color:#818cf8; background:rgba(30,41,59,0.8); }
  .upload-card input { display:none; }
  .driver-section { display:none; margin-top:20px; padding-top:20px; border-top:2px solid #334155; }
  .driver-section.show { display:block; }
  .checkbox-large { display:flex; gap:15px; align-items:center; background:rgba(30,41,59,0.6); padding:20px; border-radius:16px; border:2px solid #475569; cursor:pointer; }
  #aiDataBox { background:rgba(34,197,94,0.15); color:#4ade80; border:2px solid rgba(34,197,94,0.5); padding:20px; border-radius:16px; margin-top:20px; display:none; }
  #kycWarnings { background:rgba(251,191,36,0.15); border:2px solid rgba(251,191,36,0.5); color:#facc15; padding:20px; border-radius:16px; margin-top:20px; display:none; }
  .btn { width:100%; padding:18px; background:linear-gradient(135deg,#667eea,#764ba2); border-radius:9999px; color:white; font-size:18px; margin-top:20px; cursor:pointer; border:none; }
  .btn:hover { transform:scale(1.02); }
  .ai-fields { margin-top:15px; border-radius:16px; border:1px solid #475569; background:rgba(15,23,42,0.6); padding:16px; }
  .ai-field-row { display:flex; justify-content:space-between; padding:6px 0; font-size:14px; border-bottom:1px dashed rgba(148,163,184,0.4); }
  .ai-field-row:last-child { border-bottom:none; }
  .ai-field-row .label { color:#94a3b8; }
  .ai-field-row .value { font-weight:600; color:#e5e7eb; }
</style>
</head>
<body>
<div class="kyc-container">
  <h1 style="font-size:42px; margin-bottom:30px;">ğŸªª KYC Onboarding â€“ Varianta FinalÄƒ</h1>

  <!-- Documente Identitate -->
  <div class="section">
    <h2>ğŸ‘¤ Documente de Identitate</h2>
    <p style="color:#94a3b8;">1. ÃncarcÄƒ o pozÄƒ clarÄƒ a buletinului (faÈ›Äƒ). DupÄƒ ce datele sunt extrase, contractul apare mai jos, completat automat.</p>
    <div class="upload-grid">
      <label class="upload-card" for="idFront">
        <div style="font-size:48px;">ğŸªª</div>
        <strong>Buletin â€“ FaÈ›Äƒ</strong>
        <input id="idFront" type="file" accept="image/*,.pdf">
      </label>
      <label class="upload-card" for="idBack">
        <div style="font-size:48px;">ğŸªª</div>
        <strong>Buletin â€“ Verso</strong>
        <input id="idBack" type="file" accept="image/*,.pdf">
      </label>
      <label class="upload-card" for="selfie">
        <div style="font-size:48px;">ğŸ¤³</div>
        <strong>Selfie cu CI</strong>
        <input id="selfie" type="file" accept="image/*">
      </label>
    </div>

    <div id="aiDataBox"></div>
    <div id="kycWarnings"></div>
  </div>

  <!-- Date extrase automat din CI -->
  <div class="section" id="aiFieldsSection" style="display:none;">
    <h2>ğŸ” Date extrase automat din buletin</h2>
    <p style="color:#94a3b8;">2. Datele sunt extrase automat. ConfirmÄƒ dacÄƒ sunt corecte.</p>
    <div class="ai-fields">
      <div class="ai-field-row"><span class="label">Nume complet</span><span class="value" id="aiName"></span></div>
      <div class="ai-field-row"><span class="label">CNP</span><span class="value" id="aiCnp"></span></div>
      <div class="ai-field-row"><span class="label">Sex</span><span class="value" id="aiGender"></span></div>
      <div class="ai-field-row"><span class="label">AdresÄƒ</span><span class="value" id="aiAddress"></span></div>
      <div class="ai-field-row"><span class="label">Seria CI</span><span class="value" id="aiSeries"></span></div>
      <div class="ai-field-row"><span class="label">NumÄƒr CI</span><span class="value" id="aiNumber"></span></div>
      <div class="ai-field-row"><span class="label">Emis la</span><span class="value" id="aiIssued"></span></div>
      <div class="ai-field-row"><span class="label">ExpirÄƒ la</span><span class="value" id="aiExpire"></span></div>
    </div>

    <div style="margin-top:15px;">
      <label class="checkbox-large" style="margin-bottom:10px;">
        <input type="radio" name="aiDataOk" id="aiDataOk">
        <span>Datele sunt corecte È™i corespund buletinului meu.</span>
      </label>
      <label class="checkbox-large">
        <input type="radio" name="aiDataOk" id="aiDataNotOk">
        <span>Datele NU sunt corecte sau nu se vÄƒd clar.</span>
      </label>
    </div>

    <div id="aiFixBox" style="display:none; margin-top:15px; padding:16px; border-radius:16px; border:2px dashed #f97316; background:rgba(248,171,109,0.1); font-size:14px;">
      <p style="margin-bottom:10px;">Te rugÄƒm sÄƒ refaci poza buletinului sau sÄƒ reanalizezi poza curentÄƒ:</p>
      <button type="button" class="btn" id="retryPhotoBtn" style="width:auto; padding:10px 16px; font-size:14px; margin-right:10px;">ğŸ“· RefÄƒ poza</button>
      <button type="button" class="btn" id="reanalyseBtn" style="width:auto; padding:10px 16px; font-size:14px; background:linear-gradient(135deg,#22c55e,#16a34a);">ğŸ” ReanalizeazÄƒ</button>
    </div>
  </div>

  <!-- Contract -->
  <div class="section" id="contractSection" style="display:none;">
    <h2>ğŸ“„ Contract de colaborare</h2>
    <p style="color:#94a3b8; margin-bottom:10px;">3. ApasÄƒ pe cÃ¢mpul de mai jos pentru a deschide È™i citi contractul completat automat.</p>

    <div style="margin:12px 0 6px; padding:14px 16px; border-radius:14px; border:1px solid #334155; background:rgba(2,6,23,0.35); color:#cbd5e1; font-size:13px;">
      â³ Acest contract este valabil <strong>din data de 15 (ora 00:00)</strong> pÃ¢nÄƒ Ã®n <strong>data de 14 (ora 23:59)</strong> a lunii urmÄƒtoare.
      <div style="margin-top:6px; color:#94a3b8;">Perioada curentÄƒ: <span id="contractPeriodFrom">â€”</span> â†’ <span id="contractPeriodTo">â€”</span></div>
    </div>

    <div class="contract-trigger" id="contractTrigger">
      <div>
        <div class="contract-trigger-title">Contract de colaborare SuperParty</div>
        <div class="contract-trigger-hint">ApasÄƒ pentru a deschide È™i a citi clauzele contractului.</div>
      </div>
      <div id="contractTriggerIcon">â–¼</div>
    </div>

    <div class="contract-box" id="contractBox">
      <h3>Date colaborator (auto-completate din buletin)</h3>
      <p><strong>Nume:</strong> <span id="cName1"></span></p>
      <p><strong>CNP:</strong> <span id="cCnp1"></span></p>
      <p><strong>AdresÄƒ:</strong> <span id="cAddress1"></span></p>
      <p><strong>Seria CI:</strong> <span id="cSeries1"></span></p>
      <p><strong>NumÄƒr CI:</strong> <span id="cNumber1"></span></p>
      <p><strong>Emis la:</strong> <span id="cIssued1"></span></p>
      <p><strong>ExpirÄƒ la:</strong> <span id="cExpire1"></span></p>

      <hr style="border-color:#334155; margin:16px 0;">
      <p style="white-space:pre-line; font-size:14px; color:#f1f5f9;">
CONTRACT DE COLABORARE ARTISTICÄ‚ È˜I TEHNICÄ‚

I. PÄ‚RÈšILE CONTRACTANTE
Prezentul contract se Ã®ncheie Ã®ntre:

BENEFICIAR
Micul Om Mare SRL, CUI 42279262, cu sediul Ã®n Strada Stolnicul Vasile Nr. 17, Bl. 42, Scara 2, Etaj 1, Apartament 19, reprezentatÄƒ legal prin Ursache Andrei, denumitÄƒ Ã®n continuare BENEFICIAR,

È™i

COLABORATOR
<span id="cName2"></span>, CNP <span id="cCnp2"></span>, domiciliat Ã®n <span id="cAddress2"></span>, denumit Ã®n continuare COLABORATOR.

Ãn casul Ã®n care COLABORATORUL este minor, prezentul contract se semneazÄƒ È™i de pÄƒrintele sau tutorele legal.

II. OBIECTUL CONTRACTULUI
Art. 1
Obiectul contractului Ã®l constituie prestarea serviciilor artistice È™i tehnice pentru evenimente, incluzÃ¢nd animaÈ›ie, mascote, decoruri, baloane, vatÄƒ de zahÄƒr, popcorn, operare echipamente etc.

Art. 2
ToÈ›i clienÈ›ii È™i evenimentele aparÈ›in exclusiv BENEFICIARULUI.

III. NATURA COLABORÄ‚RII
Art. 3
Contract de colaborare / drepturi de autor, fÄƒrÄƒ program, subordonare sau salariu.

IV. EXCLUSIVITATE
Art. 4
Pe durata contractului, COLABORATORUL presteazÄƒ exclusiv pentru BENEFICIAR.

V. ÃNCÄ‚LCAREA EXCLUSIVITÄ‚ÈšII
Art. 5â€“6
ÃncÄƒlcarea exclusivitÄƒÈ›ii se sancÈ›ioneazÄƒ cu penalitÄƒÈ›i minime de 200 EUR / eveniment.

VI. MANDAT DE ÃNCASARE
Art. 7
Sumele Ã®ncasate se predau BENEFICIARULUI Ã®n maximum 24h.

VII. REMUNERAÈšIE
Art. 8â€“9
RemuneraÈ›ie variabilÄƒ, calculatÄƒ automat prin aplicaÈ›ie È™i sisteme AI.

VIII. RÄ‚SPUNDERE FAÈšÄ‚ DE CLIENT
Art. 10
COLABORATORUL rÄƒspunde pentru sumele neachitate din culpa sa.

IX. RECIZITÄ‚, COSTUME È˜I ECHIPAMENTE
Art. 11â€“12
Recuzita se predÄƒ pe inventar; deteriorÄƒrile majore se plÄƒtesc la valoare + 300 EUR.

X. AUTOVEHICUL
Art. 13â€“14
ObligaÈ›ii de preluare/predare; curÄƒÈ›area profesionalÄƒ se taxeazÄƒ cu 150 EUR.

XI. DREPTURI DE IMAGINE
Art. 15
BENEFICIARUL poate folosi fotografii/video Ã®n scop promoÈ›ional.

XII. NECONCURENÈšÄ‚ POST-CONTRACT
Art. 16
Timp de 12 luni dupÄƒ Ã®ncetare, COLABORATORUL nu poate presta servicii similare pentru clienÈ›ii BENEFICIARULUI.

XIII. APLICAÈšIA È˜I SISTEMELE AI
Art. 17
COLABORATORUL acceptÄƒ utilizarea aplicaÈ›iei È™i a sistemelor AI, regulile putÃ¢nd fi actualizate.

XIV. GDPR
Art. 18
Acceptarea prelucrÄƒrii datelor personale.

XV. REZILIERE
Art. 19
BENEFICIARUL poate rezilia imediat pentru Ã®ncÄƒlcÄƒri grave.

XVI. DISPOZIÈšII FINALE
Art. 20â€“22
Guvernare: legea romÃ¢nÄƒ. Semnare inclusiv electronicÄƒ. Litigii: instanÈ›ele din RomÃ¢nia.

SEMNÄ‚TURI
BENEFICIAR: ___________________________
COLABORATOR: ___________________________
PÄ‚RINTE/TUTORE (dacÄƒ este cazul): ___________________________
</p>
    </div>

    <br>
    <label class="checkbox-large">
      <input type="checkbox" id="contractSignCheck" disabled>
      <span>Confirm cÄƒ am citit integral contractul afiÈ™at mai sus, Ã®l Ã®nÈ›eleg, iar prin bifarea acestei cÄƒsuÈ›e Ã®mi exprim acordul ferm È™i neechivoc cu toate condiÈ›iile acestuia.</span>
    </label>
  </div>

  <!-- Minor -->
  <div class="section" id="minorSection" style="display:none;">
    <h2>ğŸ§’ Acord parental necesar</h2>
    <p style="color:#facc15; margin-bottom:10px;">ObservÄƒm cÄƒ eÈ™ti minor. Pentru a putea semna contractul de colaborare, avem nevoie de acordul scris al pÄƒrintelui sau tutorelui legal.</p>

    <div id="parentConsentStatus" style="display:none; margin:10px 0 14px; padding:14px 16px; border-radius:14px; border:1px solid rgba(34,197,94,0.4); background:rgba(34,197,94,0.12); color:#86efac; font-size:13px;"></div>

    <div class="upload-grid" id="parentConsentUploadWrap">
      <label class="upload-card" for="parentConsent">
        <div style="font-size:48px;">ğŸ“„</div>
        <strong>Acord parental semnat</strong>
        <div style="font-size:12px; color:#94a3b8; margin-top:6px;">ÃncarcÄƒ pozÄƒ sau PDF cu acordul</div>
        <input id="parentConsent" type="file" accept="image/*,.pdf">
      </label>
    </div>

    <p id="parentConsentHint" style="color:#94a3b8; margin-top:12px; font-size:13px;">âœ… Bifa de semnÄƒturÄƒ a contractului va fi disponibilÄƒ doar dupÄƒ ce existÄƒ acord parental Ã®n sistem.</p>
  </div>

  <!-- È˜ofer -->
  <div class="section">
    <h2>ğŸš— OpÈ›ional â€“ Documente È˜ofer</h2>
    <label class="checkbox-large"><input type="checkbox" id="driverCheck"> Doresc sÄƒ fiu È™ofer</label>
    <div id="driverDocs" class="driver-section">
      <div style="margin:10px 0 14px; padding:14px 16px; border-radius:14px; border:1px solid #334155; background:rgba(2,6,23,0.35); color:#cbd5e1; font-size:13px;">
        ğŸ“Œ DacÄƒ eÈ™ti È™ofer, <strong>cazierul se reÃ®ncarcÄƒ la fiecare 6 luni</strong>.
        <div style="margin-top:6px; color:#94a3b8;">Status cazier: <span id="recordStatus">â€”</span></div>
      </div>
      <div class="upload-grid">
        <label class="upload-card" for="license"><div style="font-size:48px;">ğŸªª</div><strong>Permis</strong><input id="license" type="file" accept="image/*,.pdf"></label>
        <label class="upload-card" for="record" id="recordCard"><div style="font-size:48px;">ğŸ“„</div><strong>Cazier</strong><input id="record" type="file" accept="image/*,.pdf"></label>
      </div>
    </div>
  </div>

  <button class="btn" id="submitBtn">ğŸš€ Trimite KYC</button>
</div>

<script>
"use strict";

/** CONFIG */
const BACKEND_BASE_URL = "https://superparty-ai-backend-production.up.railway.app";

/** SESSION (sp_user/sp_token) */
function readLSJson(key){
  try { return JSON.parse(localStorage.getItem(key) || "null"); }
  catch(e) { return null; }
}
function getSession(){
  const token = String(localStorage.getItem("sp_token") || "").trim();
  const user  = readLSJson("sp_user");
  const email = (user && user.email) ? String(user.email).trim() : "";
  const fullName =
    (user && (user.full_name || user.fullName || user.name))
      ? String(user.full_name || user.fullName || user.name).trim()
      : "";
  return { token, user, email, fullName };
}

/** LOGIN CHECK (ALINIAT la sesiunea realÄƒ) */
(function enforceLogin() {
  const { email, token } = getSession();
  if (!email || !token) {
    window.location.replace("/login.html");
    return;
  }
})();

function toggleDriverSection(show){
  const el = document.getElementById('driverDocs');
  if (!el) return;
  if (show) el.classList.add('show');
  else el.classList.remove('show');
  refreshDocRequirements();
}

function isMinorFromCnp(cnp){
  if (!cnp || cnp.length < 13) return false;
  const s = cnp[0];
  let prefix;
  if (s === '1' || s === '2') prefix = '19';
  else if (s === '3' || s === '4') prefix = '18';
  else if (s === '5' || s === '6') prefix = '20';
  else return false;

  const year = parseInt(prefix + cnp.substring(1,3), 10);
  const month = parseInt(cnp.substring(3,5), 10) - 1;
  const day = parseInt(cnp.substring(5,7), 10);
  const dob = new Date(year, month, day);
  if (isNaN(dob.getTime())) return false;

  const today = new Date();
  let age = today.getFullYear() - year;
  const m = today.getMonth() - month;
  if (m < 0 || (m === 0 && today.getDate() < day)) age--;
  return age < 18;
}

function addMonths(date, months){
  const d = new Date(date);
  const day = d.getDate();
  d.setMonth(d.getMonth() + months);
  if (d.getDate() !== day) d.setDate(0);
  return d;
}

function isRecordValid(recordUploadedAtISO){
  if (!recordUploadedAtISO) return false;
  const uploadedAt = new Date(recordUploadedAtISO);
  const expiresAt = addMonths(uploadedAt, 6);
  return new Date() < expiresAt;
}

/** Contract period 15 -> 14 */
function updateContractPeriod(){
  const fromEl = document.getElementById('contractPeriodFrom');
  const toEl = document.getElementById('contractPeriodTo');
  if (!fromEl || !toEl) return;

  const now = new Date();
  const y = now.getFullYear();
  const m = now.getMonth();

  const isBefore15 = now.getDate() < 15;

  const from = isBefore15 ? new Date(y, m - 1, 15, 0, 0, 0) : new Date(y, m, 15, 0, 0, 0);
  const to   = isBefore15 ? new Date(y, m, 14, 23, 59, 59) : new Date(y, m + 1, 14, 23, 59, 59);

  fromEl.textContent = from.toLocaleDateString('ro-RO');
  toEl.textContent = to.toLocaleDateString('ro-RO');
}
updateContractPeriod();

/** (DEMO) status documente existente Ã®n sistem. */
let existingDocs = {
  parentConsent: null, // { url, uploadedAt }
  driver: { record: null } // { url, uploadedAt }
};

function refreshDocRequirements(){
  const signCheck = document.getElementById('contractSignCheck');
  const parentConsentStatus = document.getElementById('parentConsentStatus');
  const parentConsentUploadWrap = document.getElementById('parentConsentUploadWrap');
  const minorSection = document.getElementById('minorSection');

  const isMinorVisible = minorSection && minorSection.style.display !== 'none';

  if (isMinorVisible) {
    if (existingDocs.parentConsent && existingDocs.parentConsent.uploadedAt) {
      parentConsentStatus.style.display = 'block';
      parentConsentStatus.textContent =
        `âœ… Acord parental deja Ã®ncÄƒrcat Ã®n sistem (data: ${new Date(existingDocs.parentConsent.uploadedAt).toLocaleDateString('ro-RO')}).`;
      parentConsentUploadWrap.style.display = 'none';
      if (signCheck) signCheck.disabled = false;
    } else {
      parentConsentStatus.style.display = 'none';
      parentConsentUploadWrap.style.display = 'grid';
      if (signCheck) signCheck.disabled = true;
    }
  }

  const driverCheckLocal = document.getElementById('driverCheck');
  const recordInput = document.getElementById('record');
  const recordCard = document.getElementById('recordCard');
  const recordStatus = document.getElementById('recordStatus');
  const wantsDriver = !!(driverCheckLocal && driverCheckLocal.checked);

  if (wantsDriver) {
    const rec = existingDocs.driver.record;
    const valid = rec && isRecordValid(rec.uploadedAt);

    if (valid) {
      if (recordStatus) recordStatus.textContent =
        `VALID (Ã®ncÄƒrcat: ${new Date(rec.uploadedAt).toLocaleDateString('ro-RO')}, reÃ®nnoire la 6 luni)`;
      if (recordInput) recordInput.required = false;
      if (recordCard) recordCard.style.opacity = '0.55';
    } else {
      if (recordStatus) recordStatus.textContent = rec
        ? `EXPIRAT (Ã®ncÄƒrcat: ${new Date(rec.uploadedAt).toLocaleDateString('ro-RO')}) â€“ trebuie reÃ®ncÄƒrcat`
        : 'LIPSEÈ˜TE â€“ trebuie Ã®ncÄƒrcat';
      if (recordInput) recordInput.required = true;
      if (recordCard) recordCard.style.opacity = '1';
    }
  } else {
    if (recordStatus) recordStatus.textContent = 'â€”';
    if (recordInput) recordInput.required = false;
    if (recordCard) recordCard.style.opacity = '1';
  }
}

const idFrontInput = document.getElementById('idFront');
const idBackInput = document.getElementById('idBack');
const selfieInput = document.getElementById('selfie');
const aiBox = document.getElementById('aiDataBox');
const warnBox = document.getElementById('kycWarnings');
const contractSection = document.getElementById('contractSection');
const aiFieldsSection = document.getElementById('aiFieldsSection');
const okRadio = document.getElementById('aiDataOk');
const notOkRadio = document.getElementById('aiDataNotOk');
const fixBoxEl = document.getElementById('aiFixBox');
const reanalyseBtn = document.getElementById('reanalyseBtn');
const retryPhotoBtn = document.getElementById('retryPhotoBtn');
const minorSectionEl = document.getElementById('minorSection');

let lastIdFrontFile = null;

async function processIdFront(file) {
  if (!file) return;

  lastIdFrontFile = file;

  const fakeAiResponse = {
    success: true,
    data: {
      firstName: 'ANDREI',
      lastName: 'URSACHE',
      gender: 'M',
      cnp: '1950101123456',
      address: 'BucureÈ™ti, Str. Exemplu 10',
      series: 'XX',
      number: '123456',
      issuedAt: '2021-05-10',
      expiresAt: '2031-05-10'
    },
    missingFields: [],
    warnings: []
  };

  const d = fakeAiResponse.data;

  document.getElementById('aiName').textContent = d.firstName + ' ' + d.lastName;
  document.getElementById('aiCnp').textContent = d.cnp;
  document.getElementById('aiGender').textContent = d.gender === 'F' ? 'Femeie' : 'BÄƒrbat';
  document.getElementById('aiAddress').textContent = d.address;
  document.getElementById('aiSeries').textContent = d.series;
  document.getElementById('aiNumber').textContent = d.number;
  document.getElementById('aiIssued').textContent = d.issuedAt;
  document.getElementById('aiExpire').textContent = d.expiresAt;

  document.getElementById('cName1').textContent = d.firstName + ' ' + d.lastName;
  document.getElementById('cCnp1').textContent = d.cnp;
  document.getElementById('cAddress1').textContent = d.address;
  document.getElementById('cSeries1').textContent = d.series;
  document.getElementById('cNumber1').textContent = d.number;
  document.getElementById('cIssued1').textContent = d.issuedAt;
  document.getElementById('cExpire1').textContent = d.expiresAt;

  document.getElementById('cName2').textContent = d.firstName + ' ' + d.lastName;
  document.getElementById('cCnp2').textContent = d.cnp;
  document.getElementById('cAddress2').textContent = d.address;

  aiBox.style.display = 'block';
  aiBox.innerHTML = `âœ… Datele principale au fost extrase automat din buletin. VerificÄƒ mai jos dacÄƒ sunt corecte.`;

  if (fakeAiResponse.warnings.length || fakeAiResponse.missingFields.length) {
    warnBox.style.display = 'block';
    warnBox.innerHTML = `âš ï¸ AI-ul nu a putut citi clar: ${fakeAiResponse.missingFields.join(', ')}`;
  } else {
    warnBox.style.display = 'none';
  }

  if (aiFieldsSection) aiFieldsSection.style.display = 'block';
  if (contractSection) contractSection.style.display = 'block';

  if (okRadio) okRadio.checked = false;
  if (notOkRadio) notOkRadio.checked = false;
  if (fixBoxEl) fixBoxEl.style.display = 'none';

  const signCheck = document.getElementById('contractSignCheck');
  const isMinor = isMinorFromCnp(d.cnp);

  if (isMinor) {
    if (minorSectionEl) minorSectionEl.style.display = 'block';
    if (signCheck) signCheck.disabled = true;
  } else {
    if (minorSectionEl) minorSectionEl.style.display = 'none';
    if (signCheck) signCheck.disabled = false;
  }

  refreshDocRequirements();

  if (aiFieldsSection) {
    aiFieldsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

if (idFrontInput) {
  idFrontInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    await processIdFront(file);
  });
}

if (okRadio && notOkRadio && fixBoxEl) {
  okRadio.addEventListener('change', () => {
    if (okRadio.checked) fixBoxEl.style.display = 'none';
  });
  notOkRadio.addEventListener('change', () => {
    if (notOkRadio.checked) fixBoxEl.style.display = 'block';
  });
}

if (reanalyseBtn) {
  reanalyseBtn.addEventListener('click', async () => {
    if (!lastIdFrontFile) {
      alert('Nu existÄƒ nicio pozÄƒ salvatÄƒ. Te rugÄƒm sÄƒ Ã®ncarci din nou buletinul.');
      return;
    }
    await processIdFront(lastIdFrontFile);
  });
}

if (retryPhotoBtn) {
  retryPhotoBtn.addEventListener('click', () => {
    if (idFrontInput) idFrontInput.click();
  });
}

const parentConsentInput = document.getElementById('parentConsent');
if (parentConsentInput) {
  parentConsentInput.addEventListener('change', () => {
    if (parentConsentInput.files && parentConsentInput.files[0]) {
      existingDocs.parentConsent = { url: 'uploaded', uploadedAt: new Date().toISOString() };
      refreshDocRequirements();
    }
  });
}

const driverCheck = document.getElementById('driverCheck');
if (driverCheck) {
  driverCheck.addEventListener('change', () => toggleDriverSection(driverCheck.checked));
}

const recordInputEl = document.getElementById('record');
if (recordInputEl) {
  recordInputEl.addEventListener('change', () => {
    if (recordInputEl.files && recordInputEl.files[0]) {
      existingDocs.driver.record = { url: 'uploaded', uploadedAt: new Date().toISOString() };
      refreshDocRequirements();
    }
  });
}

const contractTrigger = document.getElementById('contractTrigger');
const contractBoxEl = document.getElementById('contractBox');
const contractTriggerIcon = document.getElementById('contractTriggerIcon');
if (contractTrigger && contractBoxEl && contractTriggerIcon) {
  contractTrigger.addEventListener('click', () => {
    const isOpen = contractBoxEl.style.display === 'block';
    contractBoxEl.style.display = isOpen ? 'none' : 'block';
    contractTriggerIcon.textContent = isOpen ? 'â–¼' : 'â–²';
  });
}

/** SUBMIT REAL: POST /api/kyc/submit (multipart) */
async function submitKYC() {
  const { email, token, fullName: sessionFullName } = getSession();
  if (!email || !token) { window.location.replace("/login.html"); return; }

  const signCheck = document.getElementById("contractSignCheck");
  if (!signCheck || signCheck.disabled || !signCheck.checked) {
    alert("Trebuie sÄƒ citeÈ™ti contractul È™i sÄƒ bifezi acordul (È™i acord parental dacÄƒ eÈ™ti minor).");
    return;
  }

  const idFront = idFrontInput?.files?.[0];
  const idBack  = idBackInput?.files?.[0];
  const selfie  = selfieInput?.files?.[0];
  if (!idFront || !idBack || !selfie) {
    alert("ÃncarcÄƒ CI faÈ›Äƒ, CI verso È™i Selfie cu CI.");
    return;
  }

  const cnp = (document.getElementById("aiCnp")?.textContent || "").trim();
  const isMinor = isMinorFromCnp(cnp);
  const parentConsentFile = document.getElementById("parentConsent")?.files?.[0];
  const hasParentConsentInSystem = !!(existingDocs?.parentConsent?.uploadedAt);

  if (isMinor && !hasParentConsentInSystem && !parentConsentFile) {
    alert("EÈ™ti minor: trebuie Ã®ncÄƒrcat acordul parental ca sÄƒ poÈ›i trimite KYC.");
    return;
  }

  const wantsDriver = !!driverCheck?.checked;
  const licenseFile = document.getElementById("license")?.files?.[0];
  const recordFile  = document.getElementById("record")?.files?.[0];

  const recordValidInSystem = !!(existingDocs?.driver?.record?.uploadedAt) && isRecordValid(existingDocs.driver.record.uploadedAt);
  if (wantsDriver && !recordValidInSystem && !recordFile) {
    alert("EÈ™ti È™ofer: cazierul este obligatoriu (lipseÈ™te sau e expirat).");
    return;
  }

  const fd = new FormData();
  fd.set("email", email);
  fd.set(
    "fullName",
    (document.getElementById("aiName")?.textContent || "").trim() || sessionFullName || ""
  );
  fd.set("cnp", cnp);
  fd.set("address", (document.getElementById("aiAddress")?.textContent || "").trim());

  fd.append("idFront", idFront);
  fd.append("idBack", idBack);
  fd.append("selfie", selfie);

  if (isMinor && parentConsentFile) fd.append("parentConsent", parentConsentFile);

  fd.set("isDriver", wantsDriver ? "1" : "0");
  if (wantsDriver && licenseFile) fd.append("license", licenseFile);
  if (wantsDriver && recordFile)  fd.append("record", recordFile);

  fd.set("aiDataConfirmed", document.getElementById("aiDataOk")?.checked ? "1" : "0");

  const btn = document.getElementById("submitBtn");
  if (btn) { btn.disabled = true; btn.textContent = "Se trimite KYC..."; }

  try {
    const res = await fetch(`${BACKEND_BASE_URL}/api/kyc/submit`, {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`
      },
      body: fd
    });

    const data = await res.json().catch(() => null);
    if (!res.ok || !data || data.success === false) {
      throw new Error((data && data.error) || "Nu am putut trimite KYC-ul.");
    }

    try { localStorage.setItem("userKycStatus", "pending"); } catch(e){}
    try {
      const u = readLSJson("sp_user");
      if (u) { u.status = "pending"; localStorage.setItem("sp_user", JSON.stringify(u)); }
    } catch(e){}

    alert("âœ… KYC trimis cu succes. Vei fi redirecÈ›ionat.");
    window.location.href = "/angajat/pending.html";

  } catch (e) {
    alert("âŒ Eroare: " + (e.message || "unknown"));
  } finally {
    if (btn) { btn.disabled = false; btn.textContent = "ğŸš€ Trimite KYC"; }
  }
}

document.getElementById("submitBtn")?.addEventListener("click", submitKYC);
</script>
</body>
</html>
