<script>
  (function () {
    // URL-ul backend-ului tƒÉu pentru login ANGAJAT
    const BACKEND_URL = "https://script.google.com/macros/s/AKfycbwpScVyziDaoVeuxcqdBQ3qx6j-QHy5FYoWtvlqMSsu15eXGI_l5fmo1Bg8zqP1BLyJ/exec";

    const form = document.getElementById("loginForm");
    const emailInput = document.getElementById("loginEmail");
    const passwordInput = document.getElementById("loginPassword");
    const errorEl = document.getElementById("loginError");

    if (!form) {
      console.error("Nu gƒÉsesc formularul #loginForm √Æn angajat/index.html");
      return;
    }

    form.addEventListener("submit", function (e) {
      e.preventDefault();

      const email = emailInput ? emailInput.value.trim() : "";
      const pass = passwordInput ? passwordInput.value.trim() : "";

      if (!email || !pass) {
        if (errorEl) {
          errorEl.textContent = "Te rog introdu email »ôi parolƒÉ.";
          errorEl.style.display = "block";
        } else {
          alert("Te rog introdu email »ôi parolƒÉ.");
        }
        return;
      }

      const callbackName = "cb_login_" + Date.now();

      // ‚ö†Ô∏è AICI calculƒÉm URL-ul √éNAINTE sƒÉ-l folosim
      const url =
        BACKEND_URL +
        "?action=login" +
        "&email=" + encodeURIComponent(email) +
        "&password=" + encodeURIComponent(pass) +
        "&callback=" + callbackName;

      console.log("üîç LOGIN - Email:", email);
      console.log("üîç LOGIN - Backend URL:", BACKEND_URL);
      console.log("üîç LOGIN - Full URL:", url);

      window[callbackName] = function (resp) {
        console.log("‚úÖ LOGIN JSONP RESP:", resp);

        if (!resp || !resp.success) {
          const msg = resp && resp.error ? resp.error : "Email sau parolƒÉ incorecte.";
          if (errorEl) {
            errorEl.textContent = msg;
            errorEl.style.display = "block";
          } else {
            alert(msg);
          }
          return;
        }

        // SalvƒÉm utilizatorul √Æn localStorage
        try {
          localStorage.setItem(
            "superparty_user",
            JSON.stringify({ email: resp.email, role: resp.role || "angajat" })
          );
        } catch (err) {
          console.warn("Nu pot salva √Æn localStorage:", err);
        }

        // Redirect √Æn func»õie de rol
        if (resp.role === "admin") {
          window.location.href = "/admin/index.html";
        } else {
          window.location.href = "/angajat/index.html";
        }
      };

      const s = document.createElement("script");
      s.src = url;
      s.onerror = function (err) {
        console.error("‚ùå Script JSONP NU s-a √ÆncƒÉrcat:", err);
        if (errorEl) {
          errorEl.textContent = "Nu s-a putut contacta serverul. √éncearcƒÉ din nou.";
          errorEl.style.display = "block";
        } else {
          alert("Nu s-a putut contacta serverul. √éncearcƒÉ din nou.");
        }
      };
      document.body.appendChild(s);
    });
  })();
</script>
