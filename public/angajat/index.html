<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Angajat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body{background:#0f172a;color:#fff;font-family:Arial;padding:40px}
    .card{max-width:760px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:18px 20px;margin-top:18px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);font-size:13px}
    .ok{background:rgba(16,185,129,.18);border-color:rgba(16,185,129,.35)}
    .bad{background:rgba(239,68,68,.18);border-color:rgba(239,68,68,.35)}
    a{color:#93c5fd}
    code{background:rgba(255,255,255,.08);padding:2px 6px;border-radius:6px}
  </style>

  <!-- AUTH GUARD: ruleaza primul -->
  <script src="/angajat/auth-guard.js"></script>
</head>
<body>

  <h1>Dashboard Angajat</h1>
  <p id="headline">Se verifică accesul...</p>

  <div class="card">
    <div><strong>Debug status (ca să vezi clar ce citește dashboard-ul)</strong></div>
    <div class="row" id="debugRow"></div>
    <div style="margin-top:12px;font-size:13px;opacity:.9">
      Dacă vezi redirect loop: verifică regulile de KYC/status și URL-urile.
    </div>
  </div>

  <script>
    (function(){
      // IMPORTANT: la tine pagina KYC e /angajat/kyc.html (nu /angajat/kyc/index.html)
      const KYC_URL = "/angajat/kyc.html";
      const PENDING_URL = "/angajat/pending.html";

      // MUST HAVE token + user
      const token = localStorage.getItem("sp_token");
      const rawUser = localStorage.getItem("sp_user");

      if (!token || !rawUser) {
        localStorage.removeItem("sp_token");
        localStorage.removeItem("sp_user");
        location.href = "/login.html";
        return;
      }

      let u;
      try {
        u = JSON.parse(rawUser);
      } catch (e) {
        localStorage.removeItem("sp_token");
        localStorage.removeItem("sp_user");
        location.href = "/login.html";
        return;
      }

      // Normalize strings
      const role = String(u.role || "angajat").toLowerCase();
      const status = String(u.status || "active").toLowerCase();
      const kyc = String(u.kyc_status || u.kycStatus || "pending").toLowerCase();

      // Debug pills
      const debugRow = document.getElementById("debugRow");
      function pill(label, value, ok) {
        const el = document.createElement("span");
        el.className = "pill " + (ok ? "ok" : "bad");
        el.textContent = label + ": " + (value || "(gol)");
        debugRow.appendChild(el);
      }

      pill("token", token ? "prezent" : "lipsa", !!token);
      pill("email", u.email || "(gol)", !!u.email);
      pill("role", role, role === "angajat" || role === "admin" || role === "gm");
      pill("status", status, status === "active");
      pill("kyc_status", kyc, kyc === "approved");

      // Role redirect
      if (role === "admin") { location.href = "/admin/index.html"; return; }
      if (role === "gm") { location.href = "/gm/index.html"; return; }

      // Status gate
      if (status !== "active") {
        location.href = PENDING_URL;
        return;
      }

      // KYC gate
      if (kyc !== "approved") {
        const qs = new URLSearchParams({
          from: "dashboard",
          kyc: kyc || "none"
        }).toString();
        location.href = KYC_URL + "?" + qs;
        return;
      }

      // OK
      document.getElementById("headline").textContent = "Dacă vezi asta, ești OK ✅";
    })();
  </script>

</body>
</html>
