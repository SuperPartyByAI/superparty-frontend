<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <title>SuperParty - Cont în verificare</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #1d4ed8 0, #0f172a 45%, #020617 100%);
      padding: 16px;
      color: #e5e7eb;
    }

    .card {
      background: rgba(15, 23, 42, 0.95);
      border-radius: 18px;
      padding: 24px 24px 20px 24px;
      max-width: 460px;
      width: 100%;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 14px;
    }

    .logo-mark {
      width: 38px;
      height: 38px;
      border-radius: 999px;
      background: radial-gradient(circle at 25% 0, #f97316, #db2777 40%, #1d4ed8 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 800;
      color: #f9fafb;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.9);
    }

    .logo-text-main {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .logo-text-sub {
      font-size: 11px;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.18em;
    }

    .title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .subtitle {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 16px;
    }

    .status-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 11px;
      border-radius: 999px;
      border: 1px solid rgba(234, 179, 8, 0.7);
      background: rgba(250, 204, 21, 0.13);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #facc15;
      margin-bottom: 14px;
    }

    .status-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: #facc15;
      box-shadow: 0 0 0 4px rgba(250, 204, 21, 0.22);
    }

    .info-list {
      list-style: none;
      margin-bottom: 16px;
      font-size: 13px;
      color: #e5e7eb;
    }

    .info-list li {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 8px;
    }

    .info-list li span {
      margin-top: 1px;
    }

    .highlight {
      color: #bfdbfe;
      font-weight: 500;
    }

    .buttons-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .btn-primary,
    .btn-secondary,
    .btn-logout {
      border-radius: 999px;
      border: none;
      padding: 9px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #0f172a;
    }

    .btn-secondary {
      background: rgba(15, 23, 42, 0.85);
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.8);
    }

    .btn-logout {
      background: transparent;
      color: #f97373;
      border: 1px solid rgba(248, 113, 113, 0.7);
      margin-left: auto;
    }

    .footer-note {
      margin-top: 14px;
      font-size: 11px;
      color: #9ca3af;
    }

    .strong { font-weight: 600; }

    .user-line {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 10px;
    }

    .user-line span {
      color: #e5e7eb;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="logo">
      <div class="logo-mark">SP</div>
      <div>
        <div class="logo-text-main">SuperParty</div>
        <div class="logo-text-sub">Verificare cont</div>
      </div>
    </div>

    <div class="user-line" id="userLine"></div>

    <h1 class="title">Cont în verificare / KYC</h1>
    <p class="subtitle" id="subtitleText">
      Contul tău este în proces de verificare. Urmează pașii de mai jos pentru a finaliza activarea.
    </p>

    <div class="status-chip" id="statusChip">
      <div class="status-dot" id="statusDot"></div>
      <span id="statusLabel">Status: verific...</span>
    </div>

    <ul class="info-list" id="infoList">
      <li><span>1.</span><span>Completează formularul de <span class="highlight">KYC</span> cu datele reale.</span></li>
      <li><span>2.</span><span>Încarcă pozele cerute: <span class="highlight">CI față-verso + selfie</span>.</span></li>
      <li><span>3.</span><span>Semnează <span class="highlight">contractul</span> și așteaptă aprobarea coordonatorului.</span></li>
    </ul>

    <div class="buttons-row">
      <button class="btn-primary" id="kycBtn">Completează KYC</button>
      <button class="btn-secondary" id="refreshBtn">Am completat, verifică din nou</button>
      <button class="btn-logout" id="logoutBtn">Delogare</button>
    </div>

    <p class="footer-note" id="footerNote">
      După ce contul tău este <span class="strong">aprobat</span>, vei fi redirecționat automat în dashboard.
    </p>
  </div>

  <script>
    (function () {
      const BACKEND = "https://superparty-ai-backend-production.up.railway.app";
      const DASHBOARD_URL = "/angajat/index.html";
      const LOGIN_URL = "/login.html";
      const KYC_URL = "/angajat/kyc.html";

      const userLineEl = document.getElementById("userLine");
      const statusLabelEl = document.getElementById("statusLabel");
      const subtitleTextEl = document.getElementById("subtitleText");
      const infoListEl = document.getElementById("infoList");
      const footerNoteEl = document.getElementById("footerNote");

      const kycBtn = document.getElementById("kycBtn");
      const refreshBtn = document.getElementById("refreshBtn");
      const logoutBtn = document.getElementById("logoutBtn");

      function safeJsonParse(s) { try { return JSON.parse(s); } catch (e) { return null; } }

      function logout() {
        try {
          localStorage.removeItem("sp_token");
          localStorage.removeItem("sp_user");

          // curățăm și cheile vechi, ca să nu încurce
          localStorage.removeItem("userEmail");
          localStorage.removeItem("userFullName");
          localStorage.removeItem("userRole");
          localStorage.removeItem("userStatus");
          localStorage.removeItem("userKycStatus");
        } catch (e) {}
        window.location.href = LOGIN_URL;
      }

      function setUserLineFromLocal() {
        const u = safeJsonParse(localStorage.getItem("sp_user") || "{}") || {};
        const name = u.full_name || u.fullName || u.name || "";
        const email = u.email || "";
        if (!email) return;

        userLineEl.textContent = "Logat ca: " + (name ? (name + " (" + email + ")") : email);
      }

      function renderState(state) {
        // state: { status, label, subtitle, linesHtml, footer }
        statusLabelEl.textContent = "Status: " + state.label;
        subtitleTextEl.textContent = state.subtitle;

        if (state.linesHtml) infoListEl.innerHTML = state.linesHtml;

        if (state.footer !== undefined) footerNoteEl.textContent = state.footer;

        // buton KYC: îl lăsăm mereu, dar la approved oricum redirecționăm
        if (state.hideKycBtn) kycBtn.style.display = "none";
        else kycBtn.style.display = "";
      }

      function mapBackendStatusToUI(s) {
        const status = String(s || "").toLowerCase();

        if (status === "blocked") {
          return {
            label: "blocat",
            subtitle: "Contul tău este blocat. Te rugăm să iei legătura cu un coordonator SuperParty pentru detalii.",
            linesHtml:
              "<li><span>1.</span><span>Contactează coordonatorul/managerul pentru motivul blocării.</span></li>" +
              "<li><span>2.</span><span>Nu poți primi evenimente până la deblocarea contului.</span></li>",
            footer: "Doar coordonatorul poate reactiva contul."
          };
        }

        if (status === "kyc_required") {
          return {
            label: "KYC necompletat",
            subtitle: "Pentru a putea primi evenimente, trebuie să completezi KYC și să încarci documentele.",
            linesHtml:
              "<li><span>1.</span><span>Apasă pe <span class=\"highlight\">Completează KYC</span>.</span></li>" +
              "<li><span>2.</span><span>Încarcă documentele cerute și semnează contractul.</span></li>" +
              "<li><span>3.</span><span>După trimitere, revino aici pentru status.</span></li>",
            footer: "După trimiterea KYC-ului, statusul se actualizează automat."
          };
        }

        // statusuri “în așteptare”
        if (
          status === "pending" ||
          status === "pending_admin" ||
          status === "kyc_submitted" ||
          status === "submitted" ||
          status === "in_review" ||
          status === "review" ||
          status === "kyc_pending"
        ) {
          return {
            label: "KYC trimis, așteaptă aprobare",
            subtitle: "Am primit KYC-ul tău. Un coordonator SuperParty urmează să îl verifice și să îți activeze contul.",
            linesHtml:
              "<li><span>1.</span><span>Poți verifica periodic această pagină.</span></li>" +
              "<li><span>2.</span><span>Nu este nevoie să retrimiți KYC-ul dacă l-ai completat corect.</span></li>",
            footer: "După aprobarea KYC-ului și activarea contului, vei fi redirecționat automat în dashboard."
          };
        }

        if (status === "kyc_rejected" || status === "rejected") {
          return {
            label: "KYC respins",
            subtitle: "KYC-ul trimis a fost respins. Este necesar să refaci datele/pozele conform instrucțiunilor.",
            linesHtml:
              "<li><span>1.</span><span>Verifică motivul respingerii (poze neclare, date greșite etc.).</span></li>" +
              "<li><span>2.</span><span>Apasă pe <span class=\"highlight\">Completează KYC</span> și retrimite corect.</span></li>",
            footer: "După retrimitere, contul va intra din nou în verificare."
          };
        }

        // fallback generic
        return {
          label: status || "în verificare",
          subtitle: "Contul tău este în proces de verificare. Revino periodic pentru status.",
          footer: "După aprobare, vei fi redirecționat automat în dashboard."
        };
      }

      async function checkStatusAndMaybeRedirect() {
        const token = localStorage.getItem("sp_token") || "";
        if (!token) { window.location.replace(LOGIN_URL); return; }

        setUserLineFromLocal();

        try {
          const r = await fetch(`${BACKEND}/api/auth/me`, {
            headers: { Authorization: `Bearer ${token}` }
          });

          const j = await r.json().catch(() => null);

          if (!r.ok || !j?.success || !j?.tokenUser) {
            renderState({
              label: "sesiune invalidă",
              subtitle: "Sesiunea ta nu mai este validă. Te deloghez...",
              linesHtml: "<li><span>1.</span><span>Re-autentifică-te.</span></li>",
              footer: "Redirecționare la login..."
            });
            setTimeout(logout, 800);
            return;
          }

          const tu = j.tokenUser;

          // sincronizează sp_user ca să nu rămână status vechi
          const u = safeJsonParse(localStorage.getItem("sp_user") || "{}") || {};
          u.id = tu.id; u.email = tu.email; u.role = tu.role; u.status = tu.status;
          localStorage.setItem("sp_user", JSON.stringify(u));

          // redirect dacă e aprobat
          if (String(tu.status).toLowerCase() === "approved") {
            window.location.replace(DASHBOARD_URL);
            return;
          }

          // opțional: dacă devine kyc_required, trimite direct la KYC
          if (String(tu.status).toLowerCase() === "kyc_required") {
            // dacă vrei să NU redirecționeze automat, comentează linia următoare:
            // window.location.replace(KYC_URL);
            // return;
          }

          renderState(mapBackendStatusToUI(tu.status));
        } catch (e) {
          renderState({
            label: "eroare de rețea",
            subtitle: "Nu pot verifica acum statusul (rețea). Reîncerc automat.",
            footer: "Dacă problema persistă, reîncearcă peste câteva minute."
          });
        }
      }

      // Handlere butoane
      kycBtn.addEventListener("click", function () {
        window.location.href = KYC_URL;
      });

      refreshBtn.addEventListener("click", function () {
        checkStatusAndMaybeRedirect();
      });

      logoutBtn.addEventListener("click", function () {
        logout();
      });

      // start + polling
      checkStatusAndMaybeRedirect();
      setInterval(checkStatusAndMaybeRedirect, 8000);
    })();
  </script>
</body>
</html>
