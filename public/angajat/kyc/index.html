<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>KYC Onboarding â€“ SuperParty</title>

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  background:#0f172a;
  color:#f1f5f9;
  padding:40px;
}
.kyc-container{
  max-width:1200px;
  margin:auto;
  background:rgba(15,23,42,.92);
  border-radius:30px;
  padding:50px;
  border:2px solid #334155;
}
.section{
  background:rgba(15,23,42,.85);
  border:2px solid #334155;
  border-radius:20px;
  padding:30px;
  margin-bottom:30px;
}
.upload-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:20px;
}
.upload-card{
  background:rgba(30,41,59,.6);
  border:2px dashed #475569;
  border-radius:16px;
  padding:30px;
  text-align:center;
  cursor:pointer;
}
.upload-card input{display:none}
.checkbox-large{
  display:flex;
  gap:15px;
  align-items:center;
  background:rgba(30,41,59,.6);
  padding:20px;
  border-radius:16px;
  border:2px solid #475569;
}
.btn{
  width:100%;
  padding:18px;
  background:linear-gradient(135deg,#667eea,#764ba2);
  border-radius:9999px;
  color:white;
  font-size:18px;
  margin-top:20px;
  cursor:pointer;
  border:none;
}
.btn:disabled{opacity:.5;cursor:not-allowed}
.contract-box{
  margin-top:15px;
  padding:20px;
  border-radius:16px;
  border:2px solid #475569;
  background:rgba(15,23,42,.9);
  max-height:260px;
  overflow-y:auto;
  font-size:14px;
  line-height:1.6;
}
#minorSection{display:none}
#driverDocs{display:none}
.small-note{color:#94a3b8;font-size:13px;margin-top:10px}
.warn{color:#facc15;font-size:13px;margin-top:10px}
</style>
</head>

<body>
<div class="kyc-container">
  <h1 style="font-size:40px;margin-bottom:30px;">ğŸªª KYC Onboarding</h1>

  <!-- CONTRACT -->
  <div class="section">
    <h2>ğŸ“„ Contract de colaborare</h2>
    <div class="contract-box">
      <strong>CONTRACT DE COLABORARE ARTISTICÄ‚ È˜I TEHNICÄ‚</strong><br><br>
      BENEFICIAR: <strong>Micul Om Mare SRL</strong>, CUI <strong>42279262</strong><br>
      COLABORATOR: datele tale din buletin.<br><br>

      Prin semnare confirmi acceptarea tuturor clauzelor (exclusivitate, AI, rÄƒspundere).<br><br>

      <em>NotÄƒ:</em> DacÄƒ eÈ™ti minor, contractul se semneazÄƒ È™i de pÄƒrinte/tutore, iar acordul parental Ã®ncÄƒrcat este obligatoriu.
    </div>

    <label class="checkbox-large" style="margin-top:15px;">
      <input type="checkbox" id="contractSignCheck" disabled>
      <span>Confirm cÄƒ am citit È™i semnez electronic contractul</span>
    </label>
    <div class="small-note" id="signHint">ÃncarcÄƒ buletinul È™i introdu CNP-ul ca sÄƒ putem verifica dacÄƒ eÈ™ti minor È™i sÄƒ activÄƒm semnarea.</div>
  </div>

  <!-- DOCUMENTE -->
  <div class="section">
    <h2>ğŸ‘¤ Documente identitate</h2>
    <div class="small-note">
      Ãn varianta finalÄƒ, CNP-ul va fi extras automat din buletin. Acum Ã®l introduci manual ca sÄƒ funcÈ›ioneze logica â€œminorâ€.
    </div>

    <div style="margin-top:14px;">
      <label style="display:block;margin-bottom:6px;color:#e5e7eb;font-size:13px;">CNP (pentru verificare minor)</label>
      <input id="cnpInput" inputmode="numeric" maxlength="13" placeholder="Ex: 5xxxxxxxxxxxx" style="width:100%;padding:12px 14px;border-radius:12px;border:1px solid #475569;background:rgba(15,23,42,.6);color:#f1f5f9;outline:none;">
      <div class="warn" id="cnpWarn" style="display:none;"></div>
    </div>

    <div class="upload-grid" style="margin-top:18px;">
      <label class="upload-card">
        ğŸªª<br><strong>Buletin (faÈ›Äƒ)</strong>
        <div class="small-note">Obligatoriu</div>
        <input type="file" id="idFront" accept="image/*">
      </label>
      <label class="upload-card">
        ğŸ¤³<br><strong>Selfie cu buletin</strong>
        <div class="small-note">Obligatoriu</div>
        <input type="file" id="selfie" accept="image/*">
      </label>
    </div>
  </div>

  <!-- MINOR -->
  <div class="section" id="minorSection">
    <h2>ğŸ§’ Acord parental</h2>
    <p style="color:#facc15;margin-bottom:15px;">
      EÈ™ti minor. Acordul parental este obligatoriu ca sÄƒ poÈ›i semna contractul È™i trimite KYC.
    </p>
    <label class="upload-card">
      ğŸ“„<br><strong>Acord parental semnat</strong>
      <div class="small-note">PozÄƒ sau PDF</div>
      <input type="file" id="parentConsent" accept="image/*,.pdf">
    </label>
  </div>

  <!-- È˜OFER -->
  <div class="section">
    <h2>ğŸš— OpÈ›ional â€“ È˜ofer</h2>
    <label class="checkbox-large">
      <input type="checkbox" id="driverCheck">
      <span>Doresc sÄƒ fiu È™i È™ofer</span>
    </label>

    <div id="driverDocs" style="margin-top:20px;">
      <div class="upload-grid">
        <label class="upload-card">
          ğŸªª<br><strong>Permis</strong>
          <div class="small-note">Obligatoriu dacÄƒ bifezi È™ofer</div>
          <input type="file" id="license" accept="image/*,.pdf">
        </label>
        <label class="upload-card">
          ğŸ“„<br><strong>Cazier</strong>
          <div class="small-note">Obligatoriu dacÄƒ bifezi È™ofer</div>
          <input type="file" id="record" accept="image/*,.pdf">
        </label>
      </div>
    </div>
  </div>

  <button class="btn" id="submitBtn" onclick="submitKYC()">ğŸš€ Trimite KYC</button>
</div>

<script>
const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbwpScVyziDaoVeuxcqdBQ3qx6j-QHy5FYoWtvlqMSsu15eXGI_l5fmo1Bg8zqP1BLyJ/exec';

const els = {
  idFront: document.getElementById('idFront'),
  selfie: document.getElementById('selfie'),
  cnp: document.getElementById('cnpInput'),
  cnpWarn: document.getElementById('cnpWarn'),
  minorSection: document.getElementById('minorSection'),
  parentConsent: document.getElementById('parentConsent'),
  sign: document.getElementById('contractSignCheck'),
  signHint: document.getElementById('signHint'),
  driverCheck: document.getElementById('driverCheck'),
  driverDocs: document.getElementById('driverDocs'),
  license: document.getElementById('license'),
  record: document.getElementById('record'),
  submitBtn: document.getElementById('submitBtn')
};

function normalizeCnp(raw){
  return (raw || '').replace(/\D/g,'').slice(0,13);
}

function isMinorFromCnp(cnp){
  cnp = normalizeCnp(cnp);
  if(!cnp || cnp.length !== 13) return null; // null = nu putem decide

  const s = cnp[0]; // string
  let prefix;
  if (s === '1' || s === '2') prefix = '19';
  else if (s === '3' || s === '4') prefix = '18';
  else if (s === '5' || s === '6') prefix = '20';
  else return null;

  const year = parseInt(prefix + cnp.substring(1,3), 10);
  const month = parseInt(cnp.substring(3,5), 10) - 1;
  const day = parseInt(cnp.substring(5,7), 10);

  const dob = new Date(year, month, day);
  if (isNaN(dob.getTime())) return null;

  const now = new Date();
  let age = now.getFullYear() - year;
  const m = now.getMonth() - month;
  if (m < 0 || (m === 0 && now.getDate() < day)) age--;

  return age < 18;
}

function refreshMinorUi(){
  const cnpVal = normalizeCnp(els.cnp.value);
  els.cnp.value = cnpVal;

  const minor = isMinorFromCnp(cnpVal);

  // mesaje
  els.cnpWarn.style.display = 'none';
  els.cnpWarn.textContent = '';

  // minor = null -> nu È™tim Ã®ncÄƒ
  if (minor === null) {
    els.minorSection.style.display = 'none';
    els.sign.disabled = true;
    els.sign.checked = false;
    els.signHint.textContent = 'ÃncarcÄƒ buletinul È™i introdu un CNP valid (13 cifre) ca sÄƒ activÄƒm semnarea.';
    return;
  }

  if (minor) {
    els.minorSection.style.display = 'block';
    // semnarea rÄƒmÃ¢ne blocatÄƒ pÃ¢nÄƒ la acord parental
    const hasConsent = els.parentConsent.files && els.parentConsent.files[0];
    els.sign.disabled = !hasConsent;
    if (!hasConsent) {
      els.sign.checked = false;
      els.signHint.textContent = 'EÈ™ti minor: Ã®ncarcÄƒ acordul parental ca sÄƒ poÈ›i semna contractul.';
    } else {
      els.signHint.textContent = 'Acord parental Ã®ncÄƒrcat: poÈ›i semna contractul.';
    }
  } else {
    els.minorSection.style.display = 'none';
    els.sign.disabled = false;
    els.signHint.textContent = 'PoÈ›i semna contractul.';
  }
}

els.driverCheck.addEventListener('change', e=>{
  els.driverDocs.style.display = e.target.checked ? 'block' : 'none';
});

els.cnp.addEventListener('input', refreshMinorUi);
els.parentConsent.addEventListener('change', refreshMinorUi);

// ActivÄƒm logica È™i cÃ¢nd se Ã®ncarcÄƒ buletinul (ca sÄƒ fie â€œflowâ€ logic)
els.idFront.addEventListener('change', ()=>{
  // dacÄƒ nu are 13 cifre, aratÄƒ warning (nu blocÄƒm upload, doar ghidÄƒm)
  const cnpVal = normalizeCnp(els.cnp.value);
  if (cnpVal.length !== 13) {
    els.cnpWarn.textContent = 'Introdu CNP-ul complet (13 cifre) ca sÄƒ verificÄƒm automat dacÄƒ eÈ™ti minor.';
    els.cnpWarn.style.display = 'block';
  } else {
    els.cnpWarn.style.display = 'none';
  }
  refreshMinorUi();
});

// iniÈ›ial
refreshMinorUi();

async function submitKYC(){
  // ValidÄƒri minime documente
  if (!(els.idFront.files && els.idFront.files[0])) { alert('ÃncarcÄƒ buletinul (faÈ›Äƒ).'); return; }
  if (!(els.selfie.files && els.selfie.files[0])) { alert('ÃncarcÄƒ selfie cu buletin.'); return; }

  // Minor gating
  const minor = isMinorFromCnp(els.cnp.value);
  if (minor === null) { alert('Introdu un CNP valid (13 cifre).'); return; }
  if (minor && !(els.parentConsent.files && els.parentConsent.files[0])) {
    alert('EÈ™ti minor: acordul parental este obligatoriu.');
    return;
  }

  // Contract semnat obligatoriu
  if(!els.sign.checked){ alert('SemneazÄƒ contractul Ã®nainte sÄƒ trimiÈ›i KYC.'); return; }

  // È˜ofer - docuri obligatorii dacÄƒ bifeazÄƒ
  if (els.driverCheck.checked) {
    if (!(els.license.files && els.license.files[0])) { alert('Ai bifat È™ofer: Ã®ncarcÄƒ permisul.'); return; }
    if (!(els.record.files && els.record.files[0])) { alert('Ai bifat È™ofer: Ã®ncarcÄƒ cazierul.'); return; }
  }

  // user din localStorage
  let user;
  try{ user = JSON.parse(localStorage.getItem('superparty_user')); } catch(e){}
  if(!user || !user.email){
    alert('RelogheazÄƒ-te (nu am gÄƒsit utilizatorul curent).');
    window.location.href = '../index.html';
    return;
  }

  // Apel backend (simplu, ca la tine)
  els.submitBtn.disabled = true;
  els.submitBtn.textContent = 'Se trimite...';

  try{
    const url = `${BACKEND_URL}?action=completeKYC&email=${encodeURIComponent(user.email)}`;
    const r = await fetch(url);
    const j = await r.json();
    // dacÄƒ backend Ã®ntoarce user nou, Ã®l salvÄƒm
    if (j && j.success && j.user) user = j.user;
  } catch(e){
    // ok, mergem pe local fallback
  }

  // fallback local
  user.kyc_status = true;
  user.contract_signed = true;
  user.driver_opt_in = !!els.driverCheck.checked;

  localStorage.setItem('superparty_user', JSON.stringify(user));

  alert('âœ… KYC finalizat');
  window.location.href = '../index.html';
}
</script>
</body>
</html>
