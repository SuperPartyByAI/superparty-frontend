// public/auth-gate.js
// Se include DOAR pe paginile protejate.
// Necesită <script src="/sp-config.js"></script> și <script src="/auth.js"></script> înainte.

(function () {
  "use strict";

  // Dacă SDK-ul nu e încărcat corect, nu putem valida sesiunea.
  if (!window.auth) {
    window.location.href = "/login.html";
    return;
  }

  // Dacă nu e logat -> redirect /login.html
  if (!auth.isLoggedIn()) {
    window.location.href = "/login.html";
    return;
  }

  const user = auth.getUser();
  if (!user) {
    window.location.href = "/login.html";
    return;
  }

  const status = user.status ? String(user.status).toLowerCase() : "";
  const path = (window.location.pathname || "").toLowerCase();

  // paginile tale (le poți redenumi aici o singură dată dacă schimbi ceva pe viitor)
  const P = {
    waiting: "/waiting-approval.html",
    kyc: "/kyc.html",
    dash: "/dashboard.html",
  };

  function go(to) {
    const target = String(to || "").toLowerCase();
    if (target && path !== target) window.location.href = to;
  }

  // grupuri status (ca să nu se rupă când mai adaugi variante)
  const isPendingAdmin =
    status === "pending_admin" ||
    status === "pending" ||
    status === "awaiting_admin" ||
    status === "waiting_admin";

  const isKycNeeded =
    status === "kyc_required" ||
    status === "kyc_incomplete" ||
    status === "kyc_pending";

  const isOk =
    status === "active" ||
    status === "approved" ||
    status === "ok";

  // 1) dacă e pending admin -> merge doar pe waiting
  if (isPendingAdmin) {
    if (path !== P.waiting) go(P.waiting);
    return;
  }

  // 2) dacă trebuie KYC -> merge doar pe kyc
  if (isKycNeeded) {
    if (path !== P.kyc) go(P.kyc);
    return;
  }

  // 3) dacă e ok -> nu are voie să stea pe waiting/kyc
  if (isOk) {
    if (path === P.waiting || path === P.kyc) go(P.dash);
    return;
  }

  // fallback: status necunoscut -> trimitem în dashboard (sau poți trimite pe waiting)
  // dacă vrei mai strict, schimbă în: go(P.waiting)
  if (path === P.waiting || path === P.kyc) go(P.dash);
})();
