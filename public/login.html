// Endpoint backend Railway
const API_BASE = "https://superparty-ai-backend-production.up.railway.app";

const form = document.getElementById("loginForm");
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const loginBtn = document.getElementById("loginBtn");
const errorBox = document.getElementById("errorBox");
const successBox = document.getElementById("successBox");

function setLoading(isLoading) {
  loginBtn.disabled = isLoading;
  loginBtn.textContent = isLoading ? "Se autentifică..." : "Intră în cont";
}

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  errorBox.textContent = "";
  successBox.textContent = "";

  const email = emailInput.value.trim();
  const password = passwordInput.value;

  if (!email || !password) {
    errorBox.textContent = "Te rog să introduci emailul și parola.";
    return;
  }

  try {
    setLoading(true);

    const resp = await fetch(`${API_BASE}/api/auth/login`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ email, password }),
    });

    const data = await resp.json();

    if (!resp.ok || !data.success) {
      const msg = data && data.error ? data.error : "Eroare la autentificare.";
      errorBox.textContent = msg;
      setLoading(false);
      return;
    }

    const user = data.user || {};

    // Salvăm user-ul în localStorage pentru dashboard + kyc
    localStorage.setItem("user", JSON.stringify(user));
    localStorage.setItem("userEmail", user.email || email);

    successBox.textContent = "Autentificare reușită. Te redirecționăm...";

    // Logica de routing după status / kyc
    const isApproved =
      user.kyc_status === "approved" &&
      user.status === "active" &&
      user.is_approved === true;

    // (optional) viitor: daca role === 'admin' => /admin/index.html
    if (user.role === "admin") {
      window.location.href = "/admin/index.html";
      return;
    }

    if (isApproved) {
      // KYC ok + cont activ → dashboard angajat
      window.location.href = "/angajat/index.html";
    } else {
      // orice alt status → KYC page
      window.location.href = "/angajat/kyc.html";
    }
  } catch (err) {
    console.error("Login error:", err);
    errorBox.textContent = "Eroare de rețea sau server. Încearcă din nou.";
  } finally {
    setLoading(false);
  }
});
